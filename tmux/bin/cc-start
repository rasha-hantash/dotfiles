#!/usr/bin/env bash
# Start the Claude Code session manager
# Usage: cc-start [name] [directory]
#   cc-start                        → starts with a session named "session-1" in CWD
#   cc-start pancake ~/workspace/personal/pancake  → starts with a named first session

SESSION="ccs"
NAME=${1:-"session-1"}
DIR=${2:-$(pwd)}

# If already inside the cc tmux session, delegate to cc-new
if [ -n "$TMUX" ]; then
    CURRENT_SESSION=$(tmux display-message -p '#S')
    if [ "$CURRENT_SESSION" = "$SESSION" ]; then
        echo "Already inside the cc session. Use cc-new instead:"
        echo "  cc-new $NAME $DIR"
        exit 1
    fi
fi

# Re-attach if session already exists
if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "Session '$SESSION' already exists. Re-attaching..."
    tmux attach -t "$SESSION"
    exit 0
fi

# Create session with first window
tmux new-session -d -s "$SESSION" -n "$NAME" -c "$DIR"

# Manually set up layout for first window (after-new-window hook doesn't fire for initial window)
tmux split-window -t "$SESSION:$NAME" -h -l 24 "~/.local/bin/tmux-sidebar"
tmux split-window -v -l 5
tmux select-pane -t "$SESSION:$NAME.1"

# Start claude in main pane
tmux send-keys -t "$SESSION:$NAME.1" "claude" Enter

# Attach
tmux attach -t "$SESSION"
