#!/usr/bin/env bash
# ccs — Claude Code session manager
# Manages multiple Claude Code sessions inside tmux

SESSION="ccs"

setup_layout() {
    local win="$SESSION:$1"
    tmux split-window -t "$win" -h -p 25 "~/.local/bin/tmux-sidebar"
    tmux split-window -t "$win.2" -v -l 5
    tmux select-pane -t "$win.1"
    tmux send-keys -t "$win.1" "claude" Enter
}

usage() {
    cat <<'EOF'
ccs — Claude Code session manager

Usage:
  ccs start [name] [dir]    Start the session manager (creates first session)
  ccs new <name> [dir]      Add a new Claude Code session tab
  ccs list                  List all active session tabs
  ccs kill [name]           Kill a session tab (or all if no name given)
  ccs help                  Show this help

Examples:
  ccs start pancake ~/workspace/personal/pancake
  ccs new rag ~/workspace/personal/technical-rag
  ccs list
  ccs kill rag
  ccs kill
EOF
}

cmd_start() {
    local name=${1:-"session-1"}
    local dir=${2:-$(pwd)}

    # If already inside the ccs tmux session, suggest ccs new
    if [ -n "$TMUX" ]; then
        local current_session
        current_session=$(tmux display-message -p '#S')
        if [ "$current_session" = "$SESSION" ]; then
            echo "Already inside the ccs session. Did you mean:"
            echo "  ccs new $name $dir"
            return 1
        fi
    fi

    # Re-attach if session already exists
    if tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "Session exists. Re-attaching..."
        tmux attach -t "$SESSION"
        return 0
    fi

    # Create session and build layout in one atomic operation.
    # No -d flag: new-session sizes to the actual terminal, so the layout
    # is built at real dimensions — no detach/attach resize mismatch.
    tmux new-session -s "$SESSION" -n "$name" -c "$dir" \; \
        split-window -h -p 25 "~/.local/bin/tmux-sidebar" \; \
        split-window -t .2 -v -l 5 \; \
        select-pane -t .1 \; \
        send-keys -t .1 "claude" Enter
}

cmd_new() {
    local name=${1:?"Usage: ccs new <name> [directory]"}
    local dir=${2:-$(pwd)}

    # Must be inside tmux
    if [ -z "$TMUX" ]; then
        echo "Not inside a tmux session. Start one first:"
        echo "  ccs start $name $dir"
        return 1
    fi

    # Create new window and set up layout
    tmux new-window -t "$SESSION" -n "$name" -c "$dir"
    setup_layout "$name"
}

cmd_list() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "No active ccs session."
        return 1
    fi

    tmux list-windows -t "$SESSION" -F '  #{window_index}  #{window_name}  #{window_active}'  | \
    while read -r idx name active; do
        if [ "$active" = "1" ]; then
            printf '  \033[1;33m▶ %s  %s\033[0m\n' "$idx" "$name"
        else
            printf '    %s  %s\n' "$idx" "$name"
        fi
    done
}

cmd_kill() {
    local name=$1

    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "No active ccs session."
        return 1
    fi

    if [ -z "$name" ]; then
        tmux kill-session -t "$SESSION"
        echo "Killed all ccs sessions."
    else
        tmux kill-window -t "$SESSION:$name"
        echo "Killed session tab: $name"
    fi
}

# Parse subcommand
case "${1:-help}" in
    start)  shift; cmd_start "$@" ;;
    new)    shift; cmd_new "$@" ;;
    list|ls) shift; cmd_list "$@" ;;
    kill)   shift; cmd_kill "$@" ;;
    help|-h|--help) usage ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'ccs help' for usage."
        exit 1
        ;;
esac
