#!/usr/bin/env bash
# ccs — Claude Code session manager
# Manages multiple Claude Code sessions inside tmux

SESSION="ccs"

# ── Catppuccin Mocha ──
C_PEACH=$'\033[38;2;250;179;135m'
C_LAVENDER=$'\033[38;2;180;190;254m'
C_BLUE=$'\033[38;2;137;180;250m'
C_SUBTEXT=$'\033[38;2;166;173;200m'
C_OVERLAY=$'\033[38;2;108;112;134m'
C_SURFACE=$'\033[38;2;69;71;90m'
C_BOLD=$'\033[1m'
C_R=$'\033[0m'

setup_layout() {
    local win="$SESSION:$1"
    tmux set-option -w -t "$win" remain-on-exit on \; \
        split-window -t "$win" -v -p 25 \; \
        split-window -t "$win.2" -h -p 30 "~/.local/bin/tmux-sidebar" \; \
        select-pane -t "$win.2"
}

usage() {
    printf "%s%sccs%s — Claude Code session manager\n" "$C_LAVENDER" "$C_BOLD" "$C_R"
    printf "\n"
    printf "%sUsage:%s\n" "$C_BLUE" "$C_R"
    printf "  %scss start%s [name] [dir]    Start or add a session tab\n" "$C_PEACH" "$C_R"
    printf "  %scss list%s                  List active sessions\n" "$C_PEACH" "$C_R"
    printf "  %scss kill%s  <name>          Kill a single session tab\n" "$C_PEACH" "$C_R"
    printf "  %scss all-kill%s              Kill all sessions\n" "$C_PEACH" "$C_R"
    printf "  %scss resume%s                Reattach to existing session\n" "$C_PEACH" "$C_R"
    printf "  %scss help%s                  Show this help\n" "$C_PEACH" "$C_R"
    printf "\n"
    printf "%sExamples:%s\n" "$C_BLUE" "$C_R"
    printf "  %s\$%s ccs start pancake ~/workspace/personal/pancake\n" "$C_OVERLAY" "$C_R"
    printf "  %s\$%s ccs start rag ~/workspace/personal/technical-rag\n" "$C_OVERLAY" "$C_R"
    printf "  %s\$%s ccs list\n" "$C_OVERLAY" "$C_R"
    printf "  %s\$%s ccs kill rag\n" "$C_OVERLAY" "$C_R"
}

cmd_start() {
    local name=${1:-"session-1"}
    local dir=${2:-$(pwd)}

    if tmux has-session -t "$SESSION" 2>/dev/null; then
        # Reject duplicate window names
        if tmux list-windows -t "$SESSION" -F '#{window_name}' | grep -qx "$name"; then
            printf "Session '%s%s%s' already exists. Pick a different name.\n" "$C_PEACH" "$name" "$C_R"
            return 1
        fi

        # Session exists — add a new window (claude launches directly, no shell echo)
        tmux new-window -t "$SESSION" -n "$name" -c "$dir" "claude"
        setup_layout "$name"

        # If we're outside tmux, attach so the user sees it
        if [ -z "$TMUX" ]; then
            tmux attach -t "$SESSION"
        fi
    else
        # No session — create from scratch.
        # new-session must run outside tmux to get real terminal dimensions.
        if [ -n "$TMUX" ]; then
            printf "No ccs session exists. Run from outside tmux first:\n"
            printf "  %scss start%s %s %s\n" "$C_PEACH" "$C_R" "$name" "$dir"
            return 1
        fi

        tmux new-session -s "$SESSION" -n "$name" -c "$dir" \; \
            set-option -w remain-on-exit on \; \
            set-hook pane-died 'respawn-pane' \; \
            split-window -v -p 25 \; \
            split-window -t .2 -h -p 30 "~/.local/bin/tmux-sidebar" \; \
            select-pane -t .2 \; \
            respawn-pane -t .1 -k "claude"
    fi
}

cmd_list() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        printf "%sNo active ccs session.%s\n" "$C_OVERLAY" "$C_R"
        return 1
    fi

    tmux list-windows -t "$SESSION" -F '#{window_index}|#{window_name}|#{window_active}|#{pane_current_path}' | \
    while IFS='|' read -r _idx name active dir; do
        dir="${dir/#$HOME/\~}"
        if [ "$active" = "1" ]; then
            printf "  %s●%s %s%s%s%s  %s%s%s\n" "$C_PEACH" "$C_R" "$C_PEACH" "$C_BOLD" "$name" "$C_R" "$C_SUBTEXT" "$dir" "$C_R"
        else
            printf "  %s·%s %s%s%s  %s%s%s\n" "$C_OVERLAY" "$C_R" "$C_OVERLAY" "$name" "$C_R" "$C_SURFACE" "$dir" "$C_R"
        fi
    done
}

cmd_resume() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        printf "%sNo active ccs session.%s Run %scss start%s to create one.\n" "$C_OVERLAY" "$C_R" "$C_PEACH" "$C_R"
        return 1
    fi

    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$SESSION"
    else
        tmux attach -t "$SESSION"
    fi
}

cmd_kill() {
    local name=${1:?"Usage: ccs kill <name>"}

    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        printf "%sNo active ccs session.%s\n" "$C_OVERLAY" "$C_R"
        return 1
    fi

    tmux kill-window -t "$SESSION:$name"
    printf "Killed: %s%s%s\n" "$C_PEACH" "$name" "$C_R"
}

cmd_kill_all() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        printf "%sNo active ccs session.%s\n" "$C_OVERLAY" "$C_R"
        return 1
    fi

    tmux kill-session -t "$SESSION"
    printf "Killed all sessions.\n"
}

case "${1:-help}" in
    start|new) shift; cmd_start "$@" ;;
    resume) cmd_resume ;;
    list|ls) shift; cmd_list "$@" ;;
    kill)   shift; cmd_kill "$@" ;;
    all-kill) cmd_kill_all ;;
    help|-h|--help) usage ;;
    *)
        printf "Unknown command: %s\n" "$1"
        printf "Run '%scss help%s' for usage.\n" "$C_PEACH" "$C_R"
        exit 1
        ;;
esac
