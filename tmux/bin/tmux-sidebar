#!/usr/bin/env zsh
# Interactive sidebar for Claude Code session tabs
# Click or Ctrl+a s to focus, Up/Down to navigate (auto-switches)

SESSION="ccs"
selected=0
window_count=0

# Cached window data — refreshed once per loop iteration
typeset -a win_indices win_names

tput civis
trap 'tput cnorm' EXIT

refresh_windows() {
    # Single tmux call per loop — everything else reads from cache
    win_indices=()
    win_names=()
    window_count=0
    local active_pos=0
    while IFS='|' read -r idx active name; do
        win_indices+=("$idx")
        win_names+=("$name")
        [[ $active == "1" ]] && active_pos=$window_count
        ((window_count++))
    done < <(tmux list-windows -t "$SESSION" -F '#{window_index}|#{window_active}|#{window_name}')
    selected=$active_pos
}

render() {
    tput cup 0 0

    printf '\033[1;37m CC Session Tabs \033[0m\033[K\n'
    printf '───────────────────────\033[K\n'

    local i=0
    while (( i < window_count )); do
        if [[ $i -eq $selected ]]; then
            printf ' \033[1;33m▶ %s  %s\033[0m\033[K\n' "${win_indices[$((i+1))]}" "${win_names[$((i+1))]}"
        else
            printf ' \033[90m  %s  %s\033[0m\033[K\n' "${win_indices[$((i+1))]}" "${win_names[$((i+1))]}"
        fi
        ((i++))
    done

    printf '───────────────────────\033[K\n'
    printf '\033[90m ↑/↓  switch session\033[0m\033[K\n'
    printf '\033[90m  q   quit sidebar\033[0m\033[K\n'

    # Clear middle area (between top section and bottom legend) line by line
    local lines=$(tput lines)
    local cur_row=$((2 + window_count + 3))  # header + divider + windows + divider + switch hint + quit hint
    while (( cur_row < lines - 3 )); do
        printf '\033[K\n'
        ((cur_row++))
    done

    # Pin focus legend to bottom of pane
    tput cup $((lines - 3)) 0
    printf '\033[90m ⌘ + p  focus sessions\033[0m\033[K\n'
    printf '\033[90m ⌘ + m  focus terminal\033[0m\033[K\n'
    printf '\033[90m ⌘ + j  focus claude\033[0m\033[K'
}

while true; do
    refresh_windows
    render

    # Read a single character with 0.1s timeout (auto-refresh when idle)
    if read -rsk1 -t 0.1 key 2>/dev/null; then
        if [[ $key == $'\033' ]]; then
            # Escape sequence — read the rest immediately
            read -rsk2 -t 0 rest 2>/dev/null
            case "$rest" in
                '[A') # Up — switch window, keep focus in sidebar for multi-step navigation
                    if (( selected > 0 )); then
                        (( selected-- ))
                        tmux select-window -t "$SESSION:${win_indices[$((selected+1))]}" \; select-pane -t :.2
                    fi
                    ;;
                '[B') # Down — switch window, keep focus in sidebar for multi-step navigation
                    if (( selected < window_count - 1 )); then
                        (( selected++ ))
                        tmux select-window -t "$SESSION:${win_indices[$((selected+1))]}" \; select-pane -t :.2
                    fi
                    ;;
            esac
        elif [[ $key == 'q' ]]; then
            break
        elif [[ $key == $'\n' || $key == $'\r' ]]; then
            # Enter — commit selection and jump to Claude pane
            tmux select-window -t "$SESSION:${win_indices[$((selected+1))]}" \; select-pane -t :.1
        fi
    fi
done
