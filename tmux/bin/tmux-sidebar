#!/usr/bin/env zsh
# Interactive sidebar for Claude Code session tabs
# Click or Ctrl+a s to focus, Up/Down to navigate (auto-switches)

SESSION="ccs"
selected=0
window_count=0

tput civis
trap 'tput cnorm' EXIT

render() {
    tput cup 0 0

    printf '\033[1;37m CC Session Tabs \033[0m\033[K\n'
    printf '───────────────────────\033[K\n'

    local i=0
    while IFS='|' read -r idx active name; do
        if [[ $i -eq $selected ]]; then
            printf ' \033[1;33m▶ %s  %s\033[0m\033[K\n' "$idx" "$name"
        else
            printf ' \033[90m  %s  %s\033[0m\033[K\n' "$idx" "$name"
        fi
        ((i++))
    done < <(tmux list-windows -t "$SESSION" -F '#{window_index}|#{window_active}|#{window_name}')

    window_count=$i

    printf '───────────────────────\033[K\n'
    printf '\033[90m ↑/↓  switch\033[0m\033[K\n'
    printf '\033[90m C-a s focus\033[0m\033[K\n'
    printf '\033[J'
}

get_window_index_at() {
    tmux list-windows -t "$SESSION" -F '#{window_index}' | sed -n "$(($1 + 1))p"
}

sync_selected() {
    # Sync selected with the actual active window so each sidebar instance
    # stays in sync after a window switch
    local i=0
    while IFS='|' read -r idx active name; do
        if [[ $active == "1" ]]; then
            selected=$i
            return
        fi
        ((i++))
    done < <(tmux list-windows -t "$SESSION" -F '#{window_index}|#{window_active}|#{window_name}')
}

while true; do
    sync_selected
    render

    # Read a single character with 1s timeout (auto-refresh when idle)
    if read -rsk1 -t 1 key 2>/dev/null; then
        if [[ $key == $'\033' ]]; then
            # Escape sequence — read the rest immediately
            read -rsk2 -t 0 rest 2>/dev/null
            case "$rest" in
                '[A') # Up — switch window, keep focus on sidebar for continued navigation
                    if (( selected > 0 )); then
                        (( selected-- ))
                        target=$(get_window_index_at $selected)
                        [[ -n $target ]] && tmux select-window -t "$SESSION:$target" && tmux select-pane -t :.2
                    fi
                    ;;
                '[B') # Down — switch window, keep focus on sidebar for continued navigation
                    if (( selected < window_count - 1 )); then
                        (( selected++ ))
                        target=$(get_window_index_at $selected)
                        [[ -n $target ]] && tmux select-window -t "$SESSION:$target" && tmux select-pane -t :.2
                    fi
                    ;;
            esac
        elif [[ $key == $'\n' || $key == $'\r' ]]; then
            # Enter — switch to selected window, focus main pane
            target=$(get_window_index_at $selected)
            if [[ -n $target ]]; then
                tmux select-window -t "$SESSION:$target"
                tmux select-pane -t :.1
            fi
        fi
    fi
done
