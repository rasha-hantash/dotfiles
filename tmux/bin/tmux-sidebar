#!/usr/bin/env zsh
# Interactive sidebar for Claude Code session tabs
# Click or Ctrl+a s to focus, Up/Down to navigate, Enter to switch

SESSION="ccs"
selected=0
window_count=0

tput civis
trap 'tput cnorm' EXIT

render() {
    tput cup 0 0

    printf '\033[1;37m CC Session Tabs \033[0m\033[K\n'
    printf '───────────────────────\033[K\n'

    local i=0
    while IFS='|' read -r idx active name; do
        if [[ $i -eq $selected ]]; then
            if [[ $active == "1" ]]; then
                printf ' \033[1;33m▶ %s  %s\033[0m\033[K\n' "$idx" "$name"
            else
                printf ' \033[7m  %s  %s\033[0m\033[K\n' "$idx" "$name"
            fi
        else
            if [[ $active == "1" ]]; then
                printf ' \033[33m▶ %s  %s\033[0m\033[K\n' "$idx" "$name"
            else
                printf ' \033[90m  %s  %s\033[0m\033[K\n' "$idx" "$name"
            fi
        fi
        ((i++))
    done < <(tmux list-windows -t "$SESSION" -F '#{window_index}|#{window_active}|#{window_name}')

    window_count=$i

    printf '───────────────────────\033[K\n'
    printf '\033[90m ↑/↓  navigate\033[0m\033[K\n'
    printf '\033[90m Enter switch\033[0m\033[K\n'
    printf '\033[90m C-a s focus\033[0m\033[K\n'
    printf '\033[J'
}

get_window_index_at() {
    tmux list-windows -t "$SESSION" -F '#{window_index}' | sed -n "$(($1 + 1))p"
}

while true; do
    render

    # Read a single character with 1s timeout (auto-refresh when idle)
    if read -rsk1 -t 1 key 2>/dev/null; then
        if [[ $key == $'\033' ]]; then
            # Escape sequence — read the rest immediately
            read -rsk2 -t 0 rest 2>/dev/null
            case "$rest" in
                '[A') # Up
                    (( selected > 0 )) && (( selected-- ))
                    ;;
                '[B') # Down
                    (( selected < window_count - 1 )) && (( selected++ ))
                    ;;
            esac
        elif [[ $key == $'\n' || $key == $'\r' ]]; then
            # Enter — switch to selected window, focus main pane
            target=$(get_window_index_at $selected)
            if [[ -n $target ]]; then
                tmux select-window -t "$SESSION:$target"
                tmux select-pane -t :.1
            fi
        fi
    fi
done
