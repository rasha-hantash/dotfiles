#!/usr/bin/env zsh
# tmux-sidebar — interactive session navigator for CCS
# Focus with ⌘P (Ghostty) or Ctrl+a s (tmux)

SESSION="ccs"
selected=0
window_count=0

# ── Catppuccin Mocha ──
C_PEACH=$'\033[38;2;250;179;135m'
C_LAVENDER=$'\033[38;2;180;190;254m'
C_BLUE=$'\033[38;2;137;180;250m'
C_SUBTEXT=$'\033[38;2;166;173;200m'
C_OVERLAY=$'\033[38;2;108;112;134m'
C_SURFACE=$'\033[38;2;69;71;90m'
C_BOLD=$'\033[1m'
C_R=$'\033[0m'

typeset -a win_indices win_names win_dirs

tput civis
trap 'tput cnorm' EXIT

refresh_windows() {
    win_indices=()
    win_names=()
    win_dirs=()
    window_count=0
    local active_pos=0
    while IFS='|' read -r idx active name dir; do
        win_indices+=("$idx")
        win_names+=("$name")
        win_dirs+=("${dir/#$HOME/~}")
        [[ $active == "1" ]] && active_pos=$window_count
        ((window_count++))
    done < <(tmux list-windows -t "$SESSION" -F '#{window_index}|#{window_active}|#{window_name}|#{pane_current_path}')
    selected=$active_pos
}

render() {
    local cols=$(tput cols)
    local lines=$(tput lines)
    local sep="${C_SURFACE}$(printf '%.0s─' {1..$cols})${C_R}"

    tput cup 0 0

    # ── Header ──
    printf " ${C_LAVENDER}${C_BOLD}ccs${C_R} ${C_OVERLAY}· %d session%s${C_R}\033[K\n" \
        "$window_count" "$([[ $window_count -ne 1 ]] && echo 's')"
    printf '%s\033[K\n' "$sep"

    # ── Session list ──
    if (( window_count == 0 )); then
        printf " ${C_OVERLAY}no sessions${C_R}\033[K\n"
    else
        local i=0
        while (( i < window_count )); do
            local name="${win_names[$((i+1))]}"
            local dir="${win_dirs[$((i+1))]}"

            if [[ $i -eq $selected ]]; then
                printf " ${C_PEACH}●${C_R} ${C_PEACH}${C_BOLD}%s${C_R}" "$name"
            else
                printf " ${C_OVERLAY}·${C_R} ${C_OVERLAY}%s${C_R}" "$name"
            fi

            # Show directory if space permits
            if (( cols > 22 )); then
                local max_dir=$(( cols - ${#name} - 5 ))
                if (( max_dir > 4 && ${#dir} > 0 )); then
                    local short_dir="$dir"
                    if (( ${#short_dir} > max_dir )); then
                        short_dir="…${short_dir: -$((max_dir - 1))}"
                    fi
                    if [[ $i -eq $selected ]]; then
                        printf " ${C_SUBTEXT}%s${C_R}" "$short_dir"
                    else
                        printf " ${C_SURFACE}%s${C_R}" "$short_dir"
                    fi
                fi
            fi

            printf '\033[K\n'
            ((i++))
        done
    fi

    # ── Clear to footer ──
    local content=$(( 2 + (window_count > 0 ? window_count : 1) ))
    local cur=$content
    while (( cur < lines - 2 )); do
        printf '\033[K\n'
        ((cur++))
    done

    # ── Footer (pinned to bottom) ──
    tput cup $((lines - 2)) 0
    printf '%s\033[K\n' "$sep"
    printf " ${C_BLUE}↑↓${C_R}${C_OVERLAY} switch${C_R}  ${C_BLUE}⌘J${C_R}${C_OVERLAY} claude${C_R}  ${C_BLUE}⌘P${C_R}${C_OVERLAY} here${C_R}  ${C_BLUE}⌘M${C_R}${C_OVERLAY} term${C_R}\033[K"
}

while true; do
    refresh_windows
    render

    if read -rsk1 -t 0.1 key 2>/dev/null; then
        if [[ $key == $'\033' ]]; then
            read -rsk2 -t 0 rest 2>/dev/null
            case "$rest" in
                '[A') # Up — keep focus in sidebar for multi-step navigation
                    if (( selected > 0 )); then
                        (( selected-- ))
                        tmux select-window -t "$SESSION:${win_indices[$((selected+1))]}" \; select-pane -t :.3
                    fi
                    ;;
                '[B') # Down — keep focus in sidebar for multi-step navigation
                    if (( selected < window_count - 1 )); then
                        (( selected++ ))
                        tmux select-window -t "$SESSION:${win_indices[$((selected+1))]}" \; select-pane -t :.3
                    fi
                    ;;
            esac
        elif [[ $key == 'q' ]]; then
            break
        elif [[ $key == $'\n' || $key == $'\r' ]]; then
            # Enter — commit selection and jump to Claude pane
            tmux select-window -t "$SESSION:${win_indices[$((selected+1))]}" \; select-pane -t :.1
        fi
    fi
done
