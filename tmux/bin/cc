#!/usr/bin/env bash
# cc — Claude Code session manager
# Manages multiple Claude Code sessions inside tmux

SESSION="cc"

usage() {
    cat <<'EOF'
cc — Claude Code session manager

Usage:
  cc start [name] [dir]    Start the session manager (creates first session)
  cc new <name> [dir]      Add a new Claude Code session tab
  cc list                  List all active session tabs
  cc kill [name]           Kill a session tab (or all if no name given)
  cc help                  Show this help

Examples:
  cc start pancake ~/workspace/personal/pancake
  cc new rag ~/workspace/personal/technical-rag
  cc list
  cc kill rag
  cc kill
EOF
}

cmd_start() {
    local name=${1:-"session-1"}
    local dir=${2:-$(pwd)}

    # If already inside the cc tmux session, suggest cc new
    if [ -n "$TMUX" ]; then
        local current_session
        current_session=$(tmux display-message -p '#S')
        if [ "$current_session" = "$SESSION" ]; then
            echo "Already inside the cc session. Did you mean:"
            echo "  cc new $name $dir"
            return 1
        fi
    fi

    # Re-attach if session already exists
    if tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "Session exists. Re-attaching..."
        tmux attach -t "$SESSION"
        return 0
    fi

    # Create session with first window
    tmux new-session -d -s "$SESSION" -n "$name" -c "$dir"

    # Set up layout for first window (after-new-window hook doesn't fire for initial window)
    tmux split-window -t "$SESSION:$name" -h -l 24 "~/.local/bin/tmux-sidebar"
    tmux split-window -v -l 5
    tmux select-pane -t "$SESSION:$name.1"

    # Start claude in main pane
    tmux send-keys -t "$SESSION:$name.1" "claude" Enter

    tmux attach -t "$SESSION"
}

cmd_new() {
    local name=${1:?"Usage: cc new <name> [directory]"}
    local dir=${2:-$(pwd)}

    # Must be inside tmux
    if [ -z "$TMUX" ]; then
        echo "Not inside a tmux session. Start one first:"
        echo "  cc start $name $dir"
        return 1
    fi

    # Create new window — the after-new-window hook handles sidebar + mini-terminal
    tmux new-window -t "$SESSION" -n "$name" -c "$dir"

    # Start claude in the main pane (pane 1)
    tmux send-keys -t "$SESSION:$name.1" "claude" Enter
}

cmd_list() {
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "No active cc session."
        return 1
    fi

    tmux list-windows -t "$SESSION" -F '  #{window_index}  #{window_name}  #{window_active}'  | \
    while read -r idx name active; do
        if [ "$active" = "1" ]; then
            printf '  \033[1;33m▶ %s  %s\033[0m\n' "$idx" "$name"
        else
            printf '    %s  %s\n' "$idx" "$name"
        fi
    done
}

cmd_kill() {
    local name=$1

    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "No active cc session."
        return 1
    fi

    if [ -z "$name" ]; then
        tmux kill-session -t "$SESSION"
        echo "Killed all cc sessions."
    else
        tmux kill-window -t "$SESSION:$name"
        echo "Killed session tab: $name"
    fi
}

# Parse subcommand
case "${1:-help}" in
    start)  shift; cmd_start "$@" ;;
    new)    shift; cmd_new "$@" ;;
    list|ls) shift; cmd_list "$@" ;;
    kill)   shift; cmd_kill "$@" ;;
    help|-h|--help) usage ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'cc help' for usage."
        exit 1
        ;;
esac
